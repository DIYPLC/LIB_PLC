<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://www.plcopen.org/xml/tc6_0200">
  <fileHeader companyName="" productName="CODESYS" productVersion="CODESYS V3.5 SP19" creationDateTime="2026-01-26T16:57:47.8952145" />
  <contentHeader name="PLC_ODOT.project" modificationDateTime="2026-01-26T16:51:59.9229809">
    <coordinateInfo>
      <fbd>
        <scaling x="1" y="1" />
      </fbd>
      <ld>
        <scaling x="1" y="1" />
      </ld>
      <sfc>
        <scaling x="1" y="1" />
      </sfc>
    </coordinateInfo>
    <addData>
      <data name="http://www.3s-software.com/plcopenxml/projectinformation" handleUnknown="implementation">
        <ProjectInformation />
      </data>
    </addData>
  </contentHeader>
  <types>
    <dataTypes />
    <pous>
      <pou name="FbPIDstep" pouType="functionBlock">
        <interface>
          <inputVars>
            <variable name="PV">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Измеренное значение регулируемого параметра 0...100[%].</xhtml>
              </documentation>
            </variable>
            <variable name="SP">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Заданное значение регулируемого параметра 0...100[%].</xhtml>
              </documentation>
            </variable>
            <variable name="COM_RST">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Полная перезагрузка.</xhtml>
              </documentation>
            </variable>
            <variable name="LMNR_HS">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Датчик обранной связи клапан открыт.</xhtml>
              </documentation>
            </variable>
            <variable name="LMNR_LS">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Датчик обранной связи клапан закрыт.</xhtml>
              </documentation>
            </variable>
            <variable name="LMNS_ON">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Включить ружной режим управления.</xhtml>
              </documentation>
            </variable>
            <variable name="LMNUP">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Команда открыть в ручном режиме. </xhtml>
              </documentation>
            </variable>
            <variable name="LMNDN">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Команда закрыть в ручном режиме. </xhtml>
              </documentation>
            </variable>
            <variable name="GAIN">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="2" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Пропорциональное усиление ошибки регулирования.</xhtml>
              </documentation>
            </variable>
            <variable name="TI">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="20" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Время интегрирования [с].</xhtml>
              </documentation>
            </variable>
            <variable name="DEADB_W">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0.5" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Зона нечувствительности к ошибке регулирования [%].</xhtml>
              </documentation>
            </variable>
            <variable name="PULSE_TM">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="1" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Минимальное время выходного импульса [с].</xhtml>
              </documentation>
            </variable>
            <variable name="BREAK_TM">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="1" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Минимально время между выходными импульсами [с].</xhtml>
              </documentation>
            </variable>
            <variable name="MTR_TM">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="55" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Время открытия исполнительного механизма с 0 до 100 [с].</xhtml>
              </documentation>
            </variable>
            <variable name="DISV">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Возмущающее воздействие к ошибке регулирования [%].</xhtml>
              </documentation>
            </variable>
            <variable name="CYCLE">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0.1" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Шаг дискретизации по времени [с].</xhtml>
              </documentation>
            </variable>
          </inputVars>
          <outputVars>
            <variable name="QLMNUP">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Открыть задвижку.</xhtml>
              </documentation>
            </variable>
            <variable name="QLMNDN">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Закрыть задвижку.</xhtml>
              </documentation>
            </variable>
          </outputVars>
          <localVars>
            <variable name="ER">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Ошибка регулирования [%].</xhtml>
              </documentation>
            </variable>
            <variable name="LMNRS_ON">
              <type>
                <BOOL />
              </type>
              <initialValue>
                <simpleValue value="FALSE" />
              </initialValue>
            </variable>
            <variable name="LMNRSVAL">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
            </variable>
            <variable name="LMNR_SIM">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
            </variable>
            <variable name="sFbPVal">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Меняется во время регулирования.</xhtml>
              </documentation>
            </variable>
            <variable name="sThrOn">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Иногда меняется во время регулирования (похоже на адаптивный гистерезис).</xhtml>
              </documentation>
            </variable>
            <variable name="siImpAus">
              <type>
                <INT />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">-100...0...+100</xhtml>
              </documentation>
            </variable>
            <variable name="stImpDauer">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
            </variable>
            <variable name="stPausDauer">
              <type>
                <REAL />
              </type>
              <initialValue>
                <simpleValue value="0" />
              </initialValue>
            </variable>
          </localVars>
          <tempVars>
            <variable name="Hvar">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">вспомогательная переменная</xhtml>
              </documentation>
            </variable>
            <variable name="ErKp">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">вспомогательная переменная</xhtml>
              </documentation>
            </variable>
            <variable name="rTi">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">время интегрирования в real !!! не удалять !!!</xhtml>
              </documentation>
            </variable>
            <variable name="AdapIn1">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Eingang 1 der Adaption der Ansprechschwelle</xhtml>
              </documentation>
            </variable>
            <variable name="AdapIn2">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Eingang 2 der Adaption der Ansprechschwelle</xhtml>
              </documentation>
            </variable>
            <variable name="iImpEin">
              <type>
                <INT />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Eingang des Impulsformers</xhtml>
              </documentation>
            </variable>
            <variable name="rThrOff">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Abschaltschwelle</xhtml>
              </documentation>
            </variable>
            <variable name="dInteg">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">Eingang des Integrierers in der Rьckfьhrung</xhtml>
              </documentation>
            </variable>
            <variable name="dThrStIn">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">three - step element input</xhtml>
              </documentation>
            </variable>
            <variable name="LmnrSim">
              <type>
                <REAL />
              </type>
              <documentation>
                <xhtml xmlns="http://www.w3.org/1999/xhtml">simulierte Stellungsrьckmeldung</xhtml>
              </documentation>
            </variable>
          </tempVars>
        </interface>
        <body>
          <ST>
            <xhtml xmlns="http://www.w3.org/1999/xhtml">//             DbPIDstep
//    +-------------------------+
//    |        FbPIDstep        |
// -&gt;-|PV                 QLMNUP|-&gt;-
//   -|SP                 QLMNDN|-&gt;-
//   -|COM_RST                  |
//   -|LMNR_HS                  |
//   -|LMNR_LS                  |
//   -|LMNS_ON                  |
//   -|LMNUP                    |
//   -|LMNDN                    |
//   -|GAIN                     |
//   -|TI                       |
//   -|DEADB_W                  |
//   -|PULSE_TM                 |
//   -|BREAK_TM                 |
//   -|MTR_TM                   |
//   -|DISV                     |
//   -|CYCLE                    |
//    +-------------------------+

IF COM_RST
THEN 
    LMNR_SIM    := LMNRSVAL;
    QLMNUP      := 0       ;
    QLMNDN      := 0       ;
    PV          := 0.0     ;
    ER          := 0.0     ;
    LMNRS_ON    := 0       ;
    LMNRSVAL    := 0.0     ;
    LMNR_SIM    := 0.0     ;
    sFbPVal     := 0.0     ;
    sThrOn      := 0.0     ;
    siImpAus    := 0       ;
    stImpDauer  := 0.0     ;
    stPausDauer := 0.0     ;
ELSE
    ErKp := SP - PV;
    IF    ErKp &lt; ( -DEADB_W) THEN  ER := ErKp + DEADB_W;
    ELSIF ErKp &gt; DEADB_W      THEN  ER := ErKp - DEADB_W;
    ELSE  ER := 0.0; END_IF;
    ErKp := ER * GAIN;
    rTi := TI;
    IF rTi &lt; CYCLE * 0.5 THEN rTi := CYCLE * 0.5; END_IF; 
    Hvar := rTi - ABS(0.01 * ErKp * MTR_TM);
    IF Hvar &lt; (rTi * 0.1)THEN rTi := rTi * 0.1; ELSE rTi := Hvar; END_IF;
    IF LMNS_ON 
    THEN 
        sFbPVal := 0.0;
    ELSE  
        IF siImpAus &lt;&gt; 0 
        THEN  
            dInteg := DINT_TO_REAL(INT_TO_DINT(siImpAus)) * CYCLE / MTR_TM;
        ELSE 
            IF (ErKp &gt; 0.0 AND LMNR_HS) OR (ErKp &lt; 0.0 AND LMNR_LS) OR (TI = 0.0)
            THEN 
                dInteg := 0.0;
            ELSE    
                dInteg  := (-ErKp) * CYCLE / rTi;
            END_IF;
        END_IF;
        sFbPVal := sFbPVal + dInteg;
        IF TI = 0.0
        THEN  
            IF    sFbPVal &gt; 100.0 THEN sFbPVal := 100.0;
            ELSIF sFbPVal &lt; 0.0   THEN sFbPVal := 0.0;
            END_IF;
        END_IF;
    END_IF;
    dThrStIn := ErKp - sFbPVal + DISV;
    AdapIn1 := ErKp;
    AdapIn2 := sFbPVal;
    rThrOff := 55.0 / MTR_TM * CYCLE;
    IF PULSE_TM &gt; CYCLE
    THEN
    Hvar := PULSE_TM;
    ELSE
    Hvar := CYCLE;
    END_IF;
    Hvar := 100.0 * Hvar / MTR_TM;
    IF NOT(LMNR_HS OR LMNR_LS)
    THEN
        IF NOT (QLMNUP OR QLMNDN)
        THEN
            IF TI &lt;&gt; 0.0
            THEN
                IF ABS(AdapIn1) &lt; ABS(AdapIn2)
                THEN
                    sThrOn := AdapIn1;
                ELSE
                    sThrOn := AdapIn2; 
                END_IF;
            ELSE
                IF PV = 0.0
                THEN
                    sThrOn := Hvar;
                ELSE 
                    sThrOn := ABS(ErKp) * 0.5;
                END_IF;
            END_IF;
            IF sThrOn &gt; 10.0 THEN sThrOn := 10.0; END_IF;
            IF sThrOn &lt; Hvar THEN sThrOn := Hvar; END_IF;
        END_IF;
    ELSE
        sThrOn := Hvar;
    END_IF;
    IF (siImpAus = 100 AND dThrStIn &gt; rThrOff) OR (dThrStIn &gt;= sThrOn)             THEN iImpEin := 100;
    ELSIF (siImpAus = -100 AND dThrStIn &lt; ( -rThrOff)) OR (dThrStIn &lt;= ( -sThrOn)) THEN iImpEin := -100;
    ELSE                                                                                iImpEin := 0;
    END_IF;
    IF LMNS_ON
    THEN
        IF LMNUP XOR LMNDN
        THEN
            IF LMNUP
            THEN
                iImpEin := 100;
            ELSE
                iImpEin := -100;
            END_IF;
        ELSE
            iImpEin := 0;
        END_IF;
    END_IF;
    IF (iImpEin = 100 AND LMNR_HS) OR (iImpEin = -100 AND LMNR_LS) THEN iImpEin := 0; END_IF;
    IF (siImpAus = -100 AND iImpEin = 100) OR (siImpAus = 100 AND iImpEin = -100)THEN iImpEin := 0; END_IF;
    IF siImpAus &lt;&gt; iImpEin
    THEN
        IF iImpEin = 0
        THEN
            IF stImpDauer &lt;= 0.0
            THEN 
                siImpAus := 0;
                stPausDauer := BREAK_TM;
            END_IF;
        ELSE
            siImpAus := iImpEin;
            stImpDauer := PULSE_TM;
        END_IF;
    END_IF;
    IF stImpDauer &gt; 0.0
    THEN
    stImpDauer := stImpDauer - CYCLE;
    ELSE
    stImpDauer := 0.0;
    END_IF;
    IF stPausDauer &gt; 0.0
    THEN
    stPausDauer := stPausDauer - CYCLE;
    ELSE
    stPausDauer := 0.0;
    END_IF;
    IF ((siImpAus = 100) AND LMNR_HS) OR ((siImpAus = -100) AND LMNR_LS)
    THEN 
      siImpAus := 0;
      stImpDauer := 0.0;
    END_IF;
    IF NOT LMNRS_ON
    THEN
        LmnrSim := LMNRSVAL;
    ELSE
        LmnrSim := DINT_TO_REAL(INT_TO_DINT(siImpAus)) * CYCLE / MTR_TM + LMNR_SIM;
        IF LmnrSim &gt;= 100.0
        THEN
            LmnrSim := 100.0;
        ELSIF  LmnrSim &lt;= 0.0
        THEN
            LmnrSim := 0.0;
        END_IF;
    END_IF;
    LMNR_SIM := LmnrSim;
    IF siImpAus = 0
    THEN
        QLMNUP := 0;
        QLMNDN := 0;
    ELSIF siImpAus = 100
    THEN 
        QLMNUP := 1;
        QLMNDN := 0;
    ELSE 
        QLMNUP := 0;
        QLMNDN := 1;
    END_IF;
END_IF;

// src CONT_S FB42
// reversed by komatic
// cross platforms by VA
//https://web.archive.org/web/20220322202418/http://plc4good.org.ua/view_post.php?id=65
//https://github.com/komatic1/SCL_regulation_control/blob/main/CONT_S.scl

(*
Добавлен: 1exan    Дата: 2020-04-26

В этом месте есть отличия от TCONT и там похоже реализация более правильная:
Здесь:
IF iImpEin=0
THEN
IF stImpDauer&lt;=T#0MS
THEN
siImpAus:=0;
stPausDauer:=BREAK_TM;
END_IF;
ELSE
siImpAus:=iImpEin;
stImpDauer:=PULSE_TM;
END_IF;
В TCONT:
IF iImpEin = 0 THEN
IF stImpDauer &lt;= 0.0 THEN
siImpAus := 0 ; stPausDauer := BREAK_TM ;
END_IF ;
ELSIF stPausDauer &lt;= 0.0 THEN
siImpAus := iImpEin ; stImpDauer := PULSE_TM ; END_IF ;

Добавлен: 1exan    Дата: 2020-04-26

Конкретно вот эта строка:
ELSIF stPausDauer &lt;= 0.0 (или T#0s) THEN
должна быть вместо простого
ELSE

Добавлен: Roman    Дата: 2021-12-02

Правильные строки:
sThrOn:=ABS(AdapIn1);
sThrOn:=ABS(AdapIn2);

IF iImpEin=0
THEN
IF stImpDauer&lt;=T#0MS
THEN
siImpAus:=0;
stPausDauer:=BREAK_TM;
END_IF;
ELSE IF stPausDauer&lt;=T#0MS
THEN
siImpAus:=iImpEin;
stImpDauer:=PULSE_TM;
END_IF; END_IF;

*)

//  +---------+
//  | GNU GPL |
//  +---------+
//  |
//  |
//  .= .-_-. =.
// ((_/)o o(\_))
//  `-'(. .)`-'
//  |/| \_/ |\
//  ( |     | )
//  /"\_____/"\
//  \__)   (__/
// @COPYLEFT ALL WRONGS RESERVED :)
// Author: VA
// Contacts: DIY.PLC.314@gmail.com
// License: GNU GPL v2
//
// https://www.youtube.com/@DIY_PLC
// https://github.com/DIYPLC
</xhtml>
          </ST>
        </body>
        <addData>
          <data name="http://www.3s-software.com/plcopenxml/objectid" handleUnknown="discard">
            <ObjectId>cc84783f-ade4-4c75-892d-5e27b51fc622</ObjectId>
          </data>
        </addData>
      </pou>
    </pous>
  </types>
  <instances>
    <configurations />
  </instances>
  <addData>
    <data name="http://www.3s-software.com/plcopenxml/projectstructure" handleUnknown="discard">
      <ProjectStructure>
        <Folder Name="LIB_PLC">
          <Object Name="FbPIDstep" ObjectId="cc84783f-ade4-4c75-892d-5e27b51fc622" />
        </Folder>
      </ProjectStructure>
    </data>
  </addData>
</project>